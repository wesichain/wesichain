name: Nightly Benchmarks

on:
  schedule:
    - cron: "0 4 * * *"
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  qdrant-nightly-bench:
    name: Qdrant Benchmark Threshold Gate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2

      - name: Run qdrant benchmark and capture peak memory
        run: |
          mkdir -p target/bench
          /usr/bin/time -v -o target/bench/rss.txt \
            cargo bench -p wesichain-qdrant --bench vs_langchain -- --sample-size 10

      - name: Evaluate benchmark thresholds
        run: |
          python3 tools/bench/evaluate_thresholds.py \
            --thresholds tools/bench/thresholds.toml \
            --criterion-root target/criterion \
            --rss-file target/bench/rss.txt \
            --waivers WAIVERS.yml \
            --dataset-size 1000

  weaviate-nightly-bench:
    name: Weaviate Benchmark Threshold Gate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2

      - name: Run weaviate benchmark and capture peak memory
        run: |
          mkdir -p target/bench
          /usr/bin/time -v -o target/bench/rss.txt \
            cargo bench -p wesichain-weaviate --bench vs_langchain -- --sample-size 10

      - name: Evaluate benchmark thresholds
        run: |
          python3 tools/bench/evaluate_thresholds.py \
            --thresholds tools/bench/thresholds.toml \
            --criterion-root target/criterion \
            --criterion-benchmark-name wesichain_object_payload \
            --rss-file target/bench/rss.txt \
            --waivers WAIVERS.yml \
            --dataset-size 1000

  agent-nightly-bench:
    name: Agent Runtime Benchmark Threshold Gate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2

      - name: Run agent runtime benchmark and capture peak memory
        run: |
          mkdir -p target/bench
          /usr/bin/time -v -o target/bench/rss-agent.txt \
            cargo bench -p wesichain-agent --bench runtime_profiles -- --sample-size 10

      - name: Evaluate agent benchmark thresholds
        run: |
          python3 tools/bench/evaluate_agent_thresholds.py \
            --thresholds tools/bench/agent-thresholds.toml \
            --criterion-root target/criterion \
            --rss-file target/bench/rss-agent.txt \
            --dataset-size 1000
